# æ•°æ®åº“è¿æ¥ä¼˜åŒ–æ€»ç»“

**ä¼˜åŒ–æ—¥æœŸ**: 2026-01-22  
**ä¼˜åŒ–äººå‘˜**: AI Assistant  
**é¡¹ç›®**: å†å²å¹´è¡¨ç½‘ç«™  
**æ•°æ®åº“**: Supabase (PostgreSQL)

---

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

åœ¨é¡¹ç›®è¿½è¸ªè¡¨ä¸­å‘ç° Supabase æ•°æ®åº“è¿æ¥é—®é¢˜ï¼Œéœ€è¦è¿›è¡Œæ£€æŸ¥å’Œä¼˜åŒ–ã€‚

### é—®é¢˜æè¿°

- é¦–æ¬¡è¯·æ±‚å“åº”æ—¶é—´é•¿è¾¾ 2159msï¼ˆ2.16ç§’ï¼‰
- æ‡’åŠ è½½æ¨¡å¼å¯¼è‡´å†·å¯åŠ¨å»¶è¿Ÿ
- ç¼ºå°‘è¿æ¥æ± é…ç½®
- ç¼ºå°‘é”™è¯¯é‡è¯•æœºåˆ¶
- ç¼ºå°‘è¿æ¥å¥åº·æ£€æŸ¥

### å½±å“èŒƒå›´

- ç”¨æˆ·æ³¨å†Œå’Œç™»å½•åŠŸèƒ½
- æ”¶è—åŠŸèƒ½
- æ‰€æœ‰éœ€è¦æ•°æ®åº“è¿æ¥çš„ API ç«¯ç‚¹

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜ 1ï¼šæ‡’åŠ è½½æ¨¡å¼å¯¼è‡´çš„é¦–æ¬¡è¯·æ±‚å»¶è¿Ÿ

**åŸå› **ï¼š
- å½“å‰ä½¿ç”¨æ‡’åŠ è½½ Supabase å®¢æˆ·ç«¯
- é¦–æ¬¡è¯·æ±‚æ—¶æ‰åˆå§‹åŒ–å®¢æˆ·ç«¯
- åœ¨ Vercel ç¯å¢ƒä¸­ï¼Œæ¯æ¬¡å†·å¯åŠ¨éƒ½ä¼šé‡æ–°åˆå§‹åŒ–

**å½±å“**ï¼š
- é¦–æ¬¡ API è¯·æ±‚å“åº”æ—¶é—´ï¼š2159ms
- ç”¨æˆ·ä½“éªŒä¸ä½³

### é—®é¢˜ 2ï¼šç¼ºå°‘è¿æ¥æ± é…ç½®

**åŸå› **ï¼š
- Supabase å®¢æˆ·ç«¯ä½¿ç”¨é»˜è®¤é…ç½®
- æ²¡æœ‰ä¼˜åŒ–è¿æ¥å‚æ•°

**å½±å“**ï¼š
- è¿æ¥èµ„æºæµªè´¹
- å¯èƒ½å¯¼è‡´è¿æ¥è¶…æ—¶

### é—®é¢˜ 3ï¼šç¼ºå°‘é”™è¯¯é‡è¯•æœºåˆ¶

**åŸå› **ï¼š
- æ•°æ®åº“æ“ä½œå¤±è´¥æ—¶æ²¡æœ‰è‡ªåŠ¨é‡è¯•
- ç½‘ç»œæ³¢åŠ¨å¯èƒ½å¯¼è‡´è¯·æ±‚å¤±è´¥

**å½±å“**ï¼š
- è¯·æ±‚å¤±è´¥ç‡é«˜
- ç”¨æˆ·ä½“éªŒå·®

### é—®é¢˜ 4ï¼šç¼ºå°‘è¿æ¥å¥åº·æ£€æŸ¥

**åŸå› **ï¼š
- æ— æ³•ç›‘æ§æ•°æ®åº“è¿æ¥çŠ¶æ€
- æ— æ³•åŠæ—¶å‘ç°è¿æ¥é—®é¢˜

**å½±å“**ï¼š
- é—®é¢˜å‘ç°å»¶è¿Ÿ
- æ•…éšœæ’æŸ¥å›°éš¾

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### ä¼˜åŒ– 1ï¼šæ”¹è¿›æ‡’åŠ è½½æœºåˆ¶

**å®æ–½å†…å®¹**ï¼š

åœ¨ [server.js](file:///e:\Program\test01\server.js#L19-L88) ä¸­ï¼š

```javascript
// æ‡’åŠ è½½ Supabase å®¢æˆ·ç«¯ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
let supabase = null;
let supabaseAuth = null;
let isInitializing = false;
let initPromise = null;
let lastHealthCheck = 0;
const HEALTH_CHECK_INTERVAL = 5 * 60 * 1000; // 5åˆ†é’Ÿå¥åº·æ£€æŸ¥é—´éš”

function getSupabaseClient() {
    if (supabase && !isInitializing) {
        return { supabase, supabaseAuth };
    }
    
    if (isInitializing && initPromise) {
        return initPromise.then(() => ({ supabase, supabaseAuth }));
    }
    
    isInitializing = true;
    initPromise = (async () => {
        try {
            const clients = require('./supabase');
            supabase = clients.supabase;
            supabaseAuth = clients.supabaseAuth;
            
            console.log('âœ“ Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
            lastHealthCheck = Date.now();
            
            return { supabase, supabaseAuth };
        } catch (error) {
            console.error('âœ— Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
            throw error;
        } finally {
            isInitializing = false;
            initPromise = null;
        }
    })();
    
    return initPromise;
}
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- é˜²æ­¢é‡å¤åˆå§‹åŒ–
- åˆå§‹åŒ–æœŸé—´è¿”å› Promiseï¼Œé¿å…å¹¶å‘åˆå§‹åŒ–
- æ·»åŠ åˆå§‹åŒ–çŠ¶æ€æ—¥å¿—

### ä¼˜åŒ– 2ï¼šæ·»åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥

**å®æ–½å†…å®¹**ï¼š

åœ¨ [server.js](file:///e:\Program\test01\server.js#L90-L110) ä¸­ï¼š

```javascript
async function checkDatabaseHealth() {
    const now = Date.now();
    if (now - lastHealthCheck < HEALTH_CHECK_INTERVAL) {
        return true;
    }
    
    try {
        const { supabase: client } = await getSupabaseClient();
        const { error } = await client.from('users').select('id').limit(1);
        
        if (error) {
            console.error('âœ— æ•°æ®åº“å¥åº·æ£€æŸ¥å¤±è´¥:', error);
            return false;
        }
        
        lastHealthCheck = now;
        console.log('âœ“ æ•°æ®åº“å¥åº·æ£€æŸ¥é€šè¿‡');
        return true;
    } catch (error) {
        console.error('âœ— æ•°æ®åº“å¥åº·æ£€æŸ¥å¼‚å¸¸:', error);
        return false;
    }
}
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- å®šæœŸæ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
- 5åˆ†é’Ÿæ£€æŸ¥é—´éš”ï¼Œé¿å…é¢‘ç¹æ£€æŸ¥
- å¤±è´¥æ—¶è¿”å› 503 çŠ¶æ€ç 

### ä¼˜åŒ– 3ï¼šå®ç°é”™è¯¯é‡è¯•æœºåˆ¶

**å®æ–½å†…å®¹**ï¼š

åœ¨ [server.js](file:///e:\Program\test01\server.js#L112-L130) ä¸­ï¼š

```javascript
async function executeWithRetry(operation, maxRetries = 3, delay = 1000) {
    let lastError;
    
    for (let i = 0; i < maxRetries; i++) {
        try {
            const result = await operation();
            return result;
        } catch (error) {
            lastError = error;
            console.warn(`æ“ä½œå¤±è´¥ï¼Œé‡è¯• ${i + 1}/${maxRetries}:`, error.message);
            
            if (i < maxRetries - 1) {
                await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
            }
        }
    }
    
    throw lastError;
}
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- è‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ•°æ®åº“æ“ä½œ
- æœ€å¤šé‡è¯• 3 æ¬¡
- æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆ1s, 2s, 3sï¼‰

### ä¼˜åŒ– 4ï¼šä¼˜åŒ– Supabase å®¢æˆ·ç«¯é…ç½®

**å®æ–½å†…å®¹**ï¼š

åœ¨ [supabase.js](file:///e:\Program\test01\supabase.js#L42-L61) ä¸­ï¼š

```javascript
const clientOptions = {
    db: {
        schema: 'public'
    },
    global: {
        headers: {
            'x-my-custom-header': 'timeline-app'
        }
    },
    auth: {
        persistSession: false,
        autoRefreshToken: false,
        detectSessionInUrl: false
    }
};

supabase = createClient(supabaseUrl, supabaseKey, clientOptions);
supabaseAuth = createClient(supabaseUrl, supabaseKey, clientOptions);
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- ç¦ç”¨ä¼šè¯æŒä¹…åŒ–ï¼ˆå‡å°‘å†…å­˜å ç”¨ï¼‰
- ç¦ç”¨è‡ªåŠ¨åˆ·æ–° Tokenï¼ˆå‡å°‘ä¸å¿…è¦çš„è¯·æ±‚ï¼‰
- æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆä¾¿äºè¿½è¸ªï¼‰

### ä¼˜åŒ– 5ï¼šæ·»åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥ä¸­é—´ä»¶

**å®æ–½å†…å®¹**ï¼š

åœ¨ [server.js](file:///e:\Program\test01\server.js#L193-L206) ä¸­ï¼š

```javascript
// æ•°æ®åº“å¥åº·æ£€æŸ¥ä¸­é—´ä»¶
app.use(async (req, res, next) => {
    if (req.path.startsWith('/api/')) {
        try {
            const isHealthy = await checkDatabaseHealth();
            if (!isHealthy) {
                return res.status(503).json({ error: 'æ•°æ®åº“è¿æ¥ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•' });
            }
        } catch (error) {
            console.error('æ•°æ®åº“å¥åº·æ£€æŸ¥å¤±è´¥:', error);
            return res.status(503).json({ error: 'æ•°æ®åº“è¿æ¥ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•' });
        }
    }
    next();
});
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- æ‰€æœ‰ API è¯·æ±‚å‰æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€
- æ•°æ®åº“ä¸å¯ç”¨æ—¶è¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯
- æå‡ç”¨æˆ·ä½“éªŒ

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœè¯„ä¼°

### æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åï¼ˆé¢„æœŸï¼‰ | æå‡ |
|------|--------|----------------|------|
| é¦–æ¬¡è¯·æ±‚å“åº”æ—¶é—´ | 2159ms | < 1000ms | 50%+ |
| æ•°æ®åº“è¿æ¥ç¨³å®šæ€§ | ä¸€èˆ¬ | ä¼˜ç§€ | - |
| é”™è¯¯é‡è¯•æˆåŠŸç‡ | 0% | 90%+ | - |
| å¥åº·æ£€æŸ¥è¦†ç›–ç‡ | 0% | 100% | - |

### å¯é æ€§æå‡

- **é”™è¯¯é‡è¯•æœºåˆ¶**ï¼šæé«˜è¯·æ±‚æˆåŠŸç‡
- **å¥åº·æ£€æŸ¥**ï¼šåŠæ—¶å‘ç°è¿æ¥é—®é¢˜
- **é˜²é‡å¤åˆå§‹åŒ–**ï¼šé¿å…èµ„æºæµªè´¹
- **æŒ‡æ•°é€€é¿**ï¼šé¿å…é›ªå´©æ•ˆåº”

---

## ğŸ§ª æµ‹è¯•è„šæœ¬

åˆ›å»ºäº†æ•°æ®åº“ä¼˜åŒ–æµ‹è¯•è„šæœ¬ï¼š

### test-db-simple.js

**æµ‹è¯•å†…å®¹**ï¼š
1. å®¢æˆ·ç«¯åˆå§‹åŒ–æ€§èƒ½
2. æ•°æ®åº“è¿æ¥æ€§èƒ½
3. è¿æ¥å¤ç”¨æ€§èƒ½ï¼ˆ5æ¬¡æŸ¥è¯¢ï¼‰
4. æ‰¹é‡æŸ¥è¯¢æ€§èƒ½
5. é”™è¯¯é‡è¯•æœºåˆ¶

**è¿è¡Œæ–¹å¼**ï¼š
```bash
node test-db-simple.js
```

**é¢„æœŸç»“æœ**ï¼š
- å®¢æˆ·ç«¯åˆå§‹åŒ–ï¼š< 100ms
- æ•°æ®åº“è¿æ¥ï¼š< 1000ms
- å¹³å‡æŸ¥è¯¢æ—¶é—´ï¼š< 100ms
- æœ€å¿«æŸ¥è¯¢æ—¶é—´ï¼š< 50ms
- æœ€æ…¢æŸ¥è¯¢æ—¶é—´ï¼š< 200ms

---

## ğŸ“‹ åç»­å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰

1. **æ·»åŠ æ•°æ®åº“è¿æ¥æ± **
   - ä½¿ç”¨ pg-pool æˆ–ç±»ä¼¼åº“
   - é…ç½®æœ€å¤§è¿æ¥æ•°
   - ä¼˜åŒ–è¿æ¥è¶…æ—¶æ—¶é—´

2. **å®ç°æŸ¥è¯¢ç¼“å­˜**
   - ä½¿ç”¨ Redis æˆ–å†…å­˜ç¼“å­˜
   - ç¼“å­˜çƒ­ç‚¹æ•°æ®
   - è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

3. **æ·»åŠ æ•°æ®åº“ç´¢å¼•**
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
   - ä¼˜åŒ–å¤åˆç´¢å¼•
   - å®šæœŸåˆ†ææŸ¥è¯¢æ€§èƒ½

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

1. **å®ç°è¯»å†™åˆ†ç¦»**
   - ä¸»åº“å¤„ç†å†™æ“ä½œ
   - ä»åº“å¤„ç†è¯»æ“ä½œ
   - é™ä½ä¸»åº“å‹åŠ›

2. **æ·»åŠ æ•°æ®åº“ç›‘æ§**
   - é›†æˆ Supabase Analytics
   - ç›‘æ§æŸ¥è¯¢æ€§èƒ½
   - è®¾ç½®å‘Šè­¦è§„åˆ™

3. **ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢**
   - å‡å°‘ N+1 æŸ¥è¯¢
   - ä½¿ç”¨æ‰¹é‡æ“ä½œ
   - ä¼˜åŒ– JOIN æŸ¥è¯¢

### é•¿æœŸä¼˜åŒ–ï¼ˆ1-2æœˆï¼‰

1. **å®ç°æ•°æ®åº“åˆ†ç‰‡**
   - æŒ‰ç”¨æˆ· ID åˆ†ç‰‡
   - é™ä½å•è¡¨å‹åŠ›
   - æå‡æŸ¥è¯¢æ€§èƒ½

2. **æ·»åŠ æ•°æ®åº“å¤‡ä»½**
   - å®šæœŸå¤‡ä»½æ•°æ®
   - å®ç°ç¾éš¾æ¢å¤
   - ç¡®ä¿æ•°æ®å®‰å…¨

3. **å®ç°æ•°æ®åº“è¿ç§»**
   - è€ƒè™‘è¿ç§»åˆ°è‡ªå»ºæ•°æ®åº“
   - æ›´çµæ´»çš„é…ç½®
   - æ›´å¥½çš„æ€§èƒ½æ§åˆ¶

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®è¿½è¸ªè¡¨](file:///e:\Program\test01\.trae\documents\é¡¹ç›®è¿½è¸ªè¡¨.md)
- [Supabaseæ•°æ®åº“è¿æ¥é—®é¢˜è§£å†³æŠ¥å‘Š](file:///e:\Program\test01\.trae\documents\Supabaseæ•°æ®åº“è¿æ¥é—®é¢˜è§£å†³æŠ¥å‘Š.md)
- [server.js](file:///e:\Program\test01\server.js)
- [supabase.js](file:///e:\Program\test01\supabase.js)

---

## ğŸ‰ æ€»ç»“

æ•°æ®åº“è¿æ¥ä¼˜åŒ–å·²å®Œæˆï¼

### å·²å®Œæˆçš„ä¼˜åŒ–

âœ… **æ”¹è¿›æ‡’åŠ è½½æœºåˆ¶**ï¼š
- é˜²æ­¢é‡å¤åˆå§‹åŒ–
- åˆå§‹åŒ–æœŸé—´è¿”å› Promise
- æ·»åŠ åˆå§‹åŒ–çŠ¶æ€æ—¥å¿—

âœ… **æ·»åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥**ï¼š
- å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
- 5åˆ†é’Ÿæ£€æŸ¥é—´éš”
- å¤±è´¥æ—¶è¿”å› 503 çŠ¶æ€ç 

âœ… **å®ç°é”™è¯¯é‡è¯•æœºåˆ¶**ï¼š
- è‡ªåŠ¨é‡è¯•å¤±è´¥æ“ä½œ
- æœ€å¤šé‡è¯• 3 æ¬¡
- æŒ‡æ•°é€€é¿ç­–ç•¥

âœ… **ä¼˜åŒ– Supabase å®¢æˆ·ç«¯é…ç½®**ï¼š
- ç¦ç”¨ä¼šè¯æŒä¹…åŒ–
- ç¦ç”¨è‡ªåŠ¨åˆ·æ–° Token
- æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´

âœ… **æ·»åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥ä¸­é—´ä»¶**ï¼š
- æ‰€æœ‰ API è¯·æ±‚å‰æ£€æŸ¥
- æ•°æ®åº“ä¸å¯ç”¨æ—¶è¿”å›å‹å¥½é”™è¯¯
- æå‡ç”¨æˆ·ä½“éªŒ

âœ… **åˆ›å»ºæµ‹è¯•è„šæœ¬**ï¼š
- æµ‹è¯•å®¢æˆ·ç«¯åˆå§‹åŒ–æ€§èƒ½
- æµ‹è¯•æ•°æ®åº“è¿æ¥æ€§èƒ½
- æµ‹è¯•è¿æ¥å¤ç”¨æ€§èƒ½

### é¢„æœŸæ•ˆæœ

- é¦–æ¬¡è¯·æ±‚å“åº”æ—¶é—´ï¼šä» 2159ms é™ä½åˆ° < 1000ms
- æ•°æ®åº“è¿æ¥ç¨³å®šæ€§ï¼šä»ä¸€èˆ¬æå‡åˆ°ä¼˜ç§€
- é”™è¯¯é‡è¯•æˆåŠŸç‡ï¼šä» 0% æå‡åˆ° 90%+
- å¥åº·æ£€æŸ¥è¦†ç›–ç‡ï¼šä» 0% æå‡åˆ° 100%

### ä¸‹ä¸€æ­¥

1. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ä¼˜åŒ–æ•ˆæœ
2. éƒ¨ç½²åˆ° Vercel å¹¶æµ‹è¯•äº‘ç«¯æ€§èƒ½
3. ç›‘æ§æ•°æ®åº“è¿æ¥çŠ¶æ€
4. æ ¹æ®å®é™…æƒ…å†µè¿›ä¸€æ­¥ä¼˜åŒ–

---

**ä¼˜åŒ–å®Œæˆæ—¥æœŸ**: 2026-01-22  
**ä¼˜åŒ–äººå‘˜**: AI Assistant  
**é¡¹ç›®çŠ¶æ€**: ä¼˜åŒ–å®Œæˆï¼Œå¾…æµ‹è¯•éªŒè¯